{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC學習平台-個人學習歷程</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/record.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <button class="menu-btn" id="menu-btn">☰</button>
        <h1>TOEIC學習平台</h1>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <div class="nav-buttons">
            <a href="{% url 'home' %}" target="_self">
                <button class="nav-btn {% if request.path == '/' %}current{% endif %}">
                    <i class="fas fa-home"></i> 首頁
                </button>
            </a>
        
            <a href="{% url 'test' %}" target="_self">
                <button class="nav-btn {% if request.path == '/test/' %}current{% endif %}">
                    <i class="fas fa-file-alt"></i> 測驗平台
                </button>
            </a>
        
            {% if user.is_authenticated %}
                <a href="{% url 'history' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/history/' %}current{% endif %}">
                        <i class="fas fa-history"></i> 歷史單字
                    </button>
                </a>
                <a href="{% url 'record' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/record/' %}current{% endif %}">
                        <i class="fas fa-user"></i> 歡迎, {{ user.nickname }}
                    </button>
                </a>
                <form id="logout-form" action="{% url 'logout' %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn">
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/login/' %}current{% endif %}">
                        <i class="fas fa-user"></i> 會員註冊/登入
                    </button>
                </a>
            {% endif %}
        </div>
    </div>
    </div>

    <div class="container">
        <div class="profile">
            <img src="{% static 'img/user.jpg' %}" alt="使用者頭像">
            <h2>歡迎，<span id="username">{{ user.nickname }}</span></h2>
            <p>總學習時數：<span id="study-hours">{{ study_hours }}</span> 小時</p>
        </div>

        <div class="interest-selection-section">
    <h3><i class="fas fa-graduation-cap"></i> 選擇您的學習興趣</h3>
    <p>請選擇您感興趣的單字類型，我們會根據您的選擇推薦單字。</p>
    <form id="interest-form">
        <div class="interest-options">
            <label>
                <input type="checkbox" name="interest" value="Business">
                <span>商業與職場</span>
            </label>
            <label>
                <input type="checkbox" name="interest" value="Technology">
                <span>科技與資訊</span>
            </label>
            <label>
                <input type="checkbox" name="interest" value="DailyLife">
                <span>日常生活</span>
            </label>
            <label>
                <input type="checkbox" name="interest" value="Academic">
                <span>學術與教育</span>
            </label>
            <label>
                <input type="checkbox" name="interest" value="Travel">
                <span>旅遊與文化</span>
            </label>
        </div>
        <button type="submit" class="save-btn"><i class="fas fa-save"></i> 儲存設定</button>
    </form>
</div>

        <div class="progress-section">
            <h3><i class="fas fa-chart-line"></i>作答情況（正確數/總作答題數）</h3> 
            <p>
                閱讀：{{ reading_correct }} / {{ reading_total }} （正確率：{{ reading_progress }}%）<br>
            </p>
            <div class="progress-bar">
                <div class="progress" style="width: {{ reading_progress }}%;"></div>
            </div>
            <p> 
                聽力：{{ listening_correct }} / {{ listening_total }} （正確率：{{ listening_progress }}%）
            </p>
            <div class="progress-bar" style="margin-top:10px;">
                <div class="progress" style="width: {{ listening_progress }}%; background: #2196f3;"></div>
            </div>
        </div>
        
        <div class="part-analysis-section">
            <h3><i class="fas fa-list-ol"></i> Part 作答分析</h3>
            {% if part_performance %}
            <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="part-radar-chart"></canvas>
                </div>
                <div class="analysis-list">
                    {% for part, data in part_performance.items %}
                        <div class="analysis-item">
                            <div class="analysis-item-content">
                                <span class="title">{{ data.display_name }}</span>
                                <span class="details">答對 {{ data.correct }} 題 / 共 {{ data.total }} 題</span>
                            </div>
                            <span class="percentage">{{ data.percentage }}%</span>
                        </div>
                    {% endfor %}
                </div>

                {{ part_performance|json_script:"part-performance-data" }}

                
            {% else %}
                <p>尚無 Part 作答紀錄。</p>
            {% endif %}
        </div>

        <div class="category-analysis-section">
            <h3><i class="fas fa-tags"></i> 題目類別作答分析</h3>
            {% if category_performance %}
                <div class="analysis-list">
                    {% for key, data in category_performance.items %}
                        <div class="analysis-item">
                            <div class="analysis-item-content">
                                <span class="title">{{ data.display_name }}</span>
                                <span class="details">答對 {{ data.correct }} 題 / 共 {{ data.total }} 題</span>
                            </div>
                            <span class="percentage">{{ data.percentage }}%</span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>尚無題目類別作答紀錄。</p>
            {% endif %}
        </div>

        <div class="personalized-advice-section">
            <h3><i class="fas fa-lightbulb"></i> 個性化學習建議</h3>
            {% if learning_suggestions %}
                <ul>
                    {% for suggestion in learning_suggestions %}
                        <li><i class="fas fa-lightbulb"></i> <span class="advice-text">{{ suggestion }}</span></li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>尚無建議，請先完成測驗以取得分析！</p>
            {% endif %}
        </div>

        <div class="test-history">
            <h3><i class="fas fa-history"></i> 已完成測驗</h3>
            <div id="exam-results-container">
                <table class="table-standard">
                    <thead>
                        <tr>
                            <th>測驗類型</th>
                            <th>日期</th>
                            <th>分數</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in page_obj %}
                        <tr>
                            <td>{{ result.part_display }}</td>
                            <td>{{ result.completed_at|date:"Y/m/d" }}</td>
                            <td>{{ result.total_score }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3">尚無測驗紀錄</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1" data-page="1">« 第一頁</a>
                    <a href="?page={{ page_obj.previous_page_number }}" data-page="{{ page_obj.previous_page_number }}">上一頁</a>
                {% endif %}

                <span class="current">
                    第 {{ page_obj.number }} 頁 / 共 {{ page_obj.paginator.num_pages }} 頁
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" data-page="{{ page_obj.next_page_number }}">下一頁</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" data-page="{{ page_obj.paginator.num_pages }}">最後一頁 »</a>
                {% endif %}
            </div>
        </div>
    </div>

 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function bindPaginationEvents() {
        const paginationLinks = document.querySelectorAll('.pagination a');
        const examResultsContainer = document.getElementById('exam-results-container');
        const currentUrl = window.location.href.split('?')[0];

        paginationLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const pageNumber = this.dataset.page;

                fetch(`${currentUrl}?page=${pageNumber}`)
                    .then(response => response.text())
                    .then(data => {
                        const newContent = new DOMParser().parseFromString(data, 'text/html').querySelector('#exam-results-container');
                        examResultsContainer.innerHTML = newContent.innerHTML;

                        const newPagination = new DOMParser().parseFromString(data, 'text/html').querySelector('.pagination');
                        document.querySelector('.pagination').innerHTML = newPagination.innerHTML;

                        bindPaginationEvents();
                    })
                    .catch(error => console.error('Error fetching pagination data:', error));
            });
        });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        bindPaginationEvents();

        // Chart.js 相關程式碼
        const scriptTag = document.getElementById('part-performance-data');
        if (scriptTag) {
            const partPerformanceData = JSON.parse(scriptTag.textContent);
            if (Object.keys(partPerformanceData).length > 0) {
                const labels = [];
                const dataPoints = [];
                for (const key in partPerformanceData) {
                    if (partPerformanceData.hasOwnProperty(key)) {
                        labels.push(partPerformanceData[key].display_name);
                        dataPoints.push(partPerformanceData[key].percentage);
                    }
                }
                const ctx = document.getElementById('part-radar-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '作答正確率 (%)',
                            data: dataPoints,
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(0, 123, 255, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '各 Part 表現分析雷達圖',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: false
                                },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 興趣選擇相關程式碼
        // 確保頁面載入時，已選的興趣被勾選
        const userInterests = "{{ user.learning_interests }}".split(',').filter(item => item !== '');
        const checkboxes = document.querySelectorAll('.interest-options input[type="checkbox"]');
        
        checkboxes.forEach(checkbox => {
            if (userInterests.includes(checkbox.value)) {
                checkbox.checked = true;
            }
        });

        // 處理表單提交
        const interestForm = document.getElementById('interest-form');
        interestForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const selectedInterests = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value)
                .join(',');

            fetch('/update-interests/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ interests: selectedInterests })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('學習興趣已成功更新！');
                } else {
                    alert('更新失敗，請稍後再試。');
                }
            })
            .catch(error => {
                    console.error('Error updating interests:', error);
                    alert('更新過程中發生錯誤。');
            });
        });
    });
</script>
    <footer class="footer">
        <div class="footer-container">
            <div class="contact-us">
                <h3>聯絡我們</h3>
                <ul>
                    <li><i class="fas fa-phone"></i><a href="tel:02 3322 2777"> 電話：02 3322 2777</a></li>
                    <li><i class="fas fa-map"></i><a href="https://maps.app.goo.gl/3NMVwufcbbTrfQNz6" target="_blank"> 地址：100台北市中正區濟南路一段321號</a></li>
                    <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d14459.01851827243!2d121.5254698!3d25.0423998!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a970a11a84ad%3A0x58e05f2528812097!2z5ZyL56uL6Ie65YyX5ZWG5qWt5aSn5a24!5e0!3m2!1szh-TW!2stw!4v1728891709611!5m2!1szh-TW!2stw"
                        height="250"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 TOEIC學習平台 版權所有</p>
        </div>
    </footer>
</body>
</html>