{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>單字關聯地圖</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{% static 'css/reading_test.css' %}">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; }
.spinner { border: 4px solid rgba(0,0,0,0.1); border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

<div class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">單字關聯地圖</h1>
    
    <div class="flex items-center space-x-2 mb-6">
        <input type="text" id="wordInput" placeholder="輸入單字，例如 'happy'" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="searchButton" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">搜尋</button>
    </div>

    <div id="resultContainer" class="min-h-[200px] flex flex-col justify-center items-center">
        <p id="message" class="text-gray-500 text-center">輸入單字並點擊搜尋以查看其相似詞。</p>
    </div>
</div>
    <a href="{% url 'home' %}" id="backButton">回到首頁</a>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const wordInput = document.getElementById('wordInput');
    const searchButton = document.getElementById('searchButton');
    const resultContainer = document.getElementById('resultContainer');

    searchButton.addEventListener('click', handleSearch);
    wordInput.addEventListener('keypress', (e) => { if(e.key==='Enter') handleSearch(); });

    const urlParams = new URLSearchParams(window.location.search);
    const initialWord = urlParams.get('word');
    if(initialWord){ wordInput.value=initialWord; handleSearch(); }

    async function handleSearch(){
        const word = wordInput.value.trim();
        if(!word) return;
        await fetchWordRelations(word);
    }

    async function fetchWordRelations(word){
        resultContainer.innerHTML = `<div class="flex flex-col items-center"><div class="spinner"></div><p class="mt-4 text-gray-500 text-center">載入中...</p></div>`;
        try{
            const response = await fetch(`/api/get_word_relations/${word}/`);
            if(!response.ok) throw new Error(`後端錯誤（${response.status}）`);
            const data = await response.json();
            if(data.error){ resultContainer.innerHTML=`<p class="text-red-500 text-center">${data.error}</p>`; return; }
            renderResults(data);
        }catch(e){ resultContainer.innerHTML=`<p class="text-red-500 text-center">錯誤: ${e.message}</p>`; console.error(e); }
    }

    function renderResults(data){
        resultContainer.innerHTML='';

        const wordCard = document.createElement('div');
        wordCard.className='bg-white p-6 rounded-xl border border-gray-300 shadow-sm w-full';
        wordCard.innerHTML=`
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-3xl font-bold text-indigo-700">${data.source_word}</h2>
                <span class="text-sm text-gray-500">${data.pronunciation||''}</span>
            </div>
            <p class="text-lg text-gray-600 mb-6">${data.translation||''}</p>
            <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">相似詞地圖</h3>
            <div id="graph" class="w-full" style="height:500px;"></div>
        `;
        resultContainer.appendChild(wordCard);

        const container = document.getElementById('graph');
        container.innerHTML='';
        const width = container.clientWidth || 600;
        const height = 500;
        const svg = d3.select("#graph").append("svg").attr("width", width).attr("height", height);

        const nodes=[], links=[];
        const colors=["#8EAF9D","#A6D8D4","#B9CDDA","#D7DAE5"]; // 顏色層級淺淡
        const nodeSet = new Set(); // 避免重複節點

        function addNode(obj,parent=null,level=0){
            if(!obj || !obj.word) return;
            if(nodeSet.has(obj.word)) return; // 重複就跳過
            nodeSet.add(obj.word);
            nodes.push({id: obj.word, type: parent?"synonym":"center", level});
            if(parent) links.push({source: parent.word, target: obj.word});
            if(obj.synonyms && Array.isArray(obj.synonyms)){
                obj.synonyms.forEach(child=>{
                    if(typeof child==="string") child={word:child,synonyms:[]};
                    addNode(child,obj,level+1);
                });
            }
        }

        addNode({word:data.source_word,synonyms:Array.isArray(data.synonyms)?data.synonyms:[]});

        // 初始化子節點靠近中心
        nodes.forEach(d=>{
            if(d.type!=="center"){
                d.x = width/2 + (Math.random()-0.5)*50;
                d.y = height/2 + (Math.random()-0.5)*50;
            }
        });

        const simulation = d3.forceSimulation(nodes)
            .force("link",d3.forceLink(links).id(d=>d.id).distance(d=>d.source.type==="center"?120:80).strength(1))
            .force("charge",d3.forceManyBody().strength(d=>d.type==="center"?-200:-70))
            .force("center",d3.forceCenter(width/2,height/2))
            .force("collision",d3.forceCollide().radius(d=>d.type==="center"?40:22))
            .alpha(1).restart();

        // 固定中心
        nodes.forEach(d=>{ if(d.type==="center"){ d.fx=width/2; d.fy=height/2; }});

        const link = svg.append("g").attr("stroke","#cbd5e1")
            .selectAll("line").data(links).enter().append("line").attr("stroke-width",1.5);

        const node = svg.append("g").selectAll("g").data(nodes)
            .enter().append("g")
            .call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));

        node.append("circle")
            .attr("r",d=>d.type==="center"?35:20)
            .attr("fill",d=>d.type==="center"?"#4B5563":colors[d.level % colors.length])
            .on("click",(event,d)=>{
                if(d.type==="synonym"){
                    wordInput.value=d.id;
                    fetchWordRelations(d.id);
                }
            });

        node.append("text")
            .text(d=>d.id)
            .attr("text-anchor","middle")
            .attr("dy",".35em")
            .attr("pointer-events","none")
            .attr("font-size",d=>d.type==="center"?14:12)
            .attr("fill",d=>d.type==="center"?"#ffffff":"#0f172a");

        simulation.on("tick",()=>{
            link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
                .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
            node.attr("transform",d=>`translate(${d.x},${d.y})`);
        });

        function dragstarted(event,d){ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
        function dragged(event,d){ d.fx=event.x; d.fy=event.y; }
        function dragended(event,d){ if(!event.active) simulation.alphaTarget(0); if(d.type!=="center"){ d.fx=null; d.fy=null; } }
    }
});
</script>
</body>
</html>
