{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>單字關聯地圖</title>
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'css/word-map.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; }
.spinner { border: 4px solid rgba(0,0,0,0.1); border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<div class="header">
        <button class="menu-btn" id="menu-btn">☰</button>
        <h1>TOEIC學習平台</h1>        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <div class="nav-buttons">
            <a href="{% url 'home' %}" target="_self">
                <button class="nav-btn {% if request.path == '/' %}current{% endif %}">
                    <i class="fas fa-home"></i> 首頁
                </button>
            </a>

            <a href="{% url 'test' %}" target="_self">
                <button class="nav-btn {% if request.path == '/test/' %}current{% endif %}">
                    <i class="fas fa-file-alt"></i> 測驗平台
                </button>
            </a>

            {% if user.is_authenticated %}
              <a href="{% url 'relation_map' %}" target="_self">
        <button class="nav-btn {% if request.path == '/relation-map/' %}current{% endif %}">
            <i class="fas fa-project-diagram"></i> 單字關聯地圖
        </button>
    </a>
                <a href="{% url 'history' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/history/' %}current{% endif %}">
                        <i class="fas fa-history"></i> 歷史單字
                    </button>
                </a>
                <a href="{% url 'record' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/record/' %}current{% endif %}">
                        <i class="fas fa-user"></i> 學習歷程
                    </button>
                </a>
                <a href="{% url 'faq' %}" target="_self">
                <button class="nav-btn {% if request.path == '/faq/' %}current{% endif %}">
                    <i class="fas fa-question-circle"></i> 常見問題
                </button>
            </a>
                <a href="{% url 'profile-settings' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/profile-settings/' %}current{% endif %}">
                        <i class="fas fa-cog"></i> 歡迎, {{ user.nickname }}
                    </button>
                </a>
                <form id="logout-form" action="{% url 'logout' %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn">
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/login/' %}current{% endif %}">
                        <i class="fas fa-user"></i> 會員註冊/登入
                    </button>
                </a>
            {% endif %}
        </div>
    </div>
<body>

<main class="word-map-container">
    <div class="word-map-card">
        <h1 class="word-map-title">單字關聯地圖</h1>
        <div class="word-map-search">
            <input type="text" id="wordInput" placeholder="輸入單字，例如 'happy'" class="word-map-input">
            <button id="searchButton" class="word-map-button">搜尋</button>
        </div>
        <div id="resultContainer" class="word-map-result">
            <p id="message" class="word-map-message">輸入單字並點擊搜尋以查看其相似詞。</p>
        </div>
    </div>
</main>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const wordInput = document.getElementById('wordInput');
    const searchButton = document.getElementById('searchButton');
    const resultContainer = document.getElementById('resultContainer');

    searchButton.addEventListener('click', handleSearch);
    wordInput.addEventListener('keypress', (e) => { if(e.key==='Enter') handleSearch(); });

    const urlParams = new URLSearchParams(window.location.search);
    const initialWord = urlParams.get('word');
    if(initialWord){ wordInput.value=initialWord; handleSearch(); }

    async function handleSearch(){
        const word = wordInput.value.trim();
        if(!word) return;
        await fetchWordRelations(word);
    }

    async function fetchWordRelations(word){
        resultContainer.innerHTML = `<div class="word-map-loading"><div class="spinner"></div><p class="word-map-loading-text">載入中...</p></div>`;
        try{
            const response = await fetch(`/api/get_word_relations/${word}/`);
            if(!response.ok) throw new Error(`後端錯誤（${response.status}）`);
            const data = await response.json();
            if(data.error){ resultContainer.innerHTML=`<p class="word-map-error">${data.error}</p>`; return; }
            renderResults(data);
        }catch(e){ resultContainer.innerHTML=`<p class="word-map-error">錯誤: ${e.message}</p>`; console.error(e); }
    }

    function renderResults(data){
        resultContainer.innerHTML='';

        const wordCard = document.createElement('div');
        wordCard.className='word-map-result-card';
        wordCard.innerHTML=`
            <div class="word-map-header">
                <h2 class="word-map-word">${data.source_word}</h2>
                <span class="word-map-pronunciation">${data.pronunciation||''}</span>
            </div>
            <p class="word-map-translation">${data.translation||''}</p>
            <h3 class="word-map-subtitle">相似詞地圖</h3>
            <div id="graph" class="word-map-graph" style="height:500px;"></div>
        `;
        resultContainer.appendChild(wordCard);

        const container = document.getElementById('graph');
        container.innerHTML='';
        const width = container.clientWidth || 600;
        const height = 500;
        const svg = d3.select("#graph").append("svg").attr("width", width).attr("height", height);

        const nodes=[], links=[];
        const colors=["#8EAF9D","#A6D8D4","#B9CDDA","#D7DAE5"]; // 顏色層級淺淡
        const nodeSet = new Set(); // 避免重複節點

        function addNode(obj,parent=null,level=0){
            if(!obj || !obj.word) return;
            if(nodeSet.has(obj.word)) return; // 重複就跳過
            nodeSet.add(obj.word);
            nodes.push({id: obj.word, type: parent?"synonym":"center", level});
            if(parent) links.push({source: parent.word, target: obj.word});
            if(obj.synonyms && Array.isArray(obj.synonyms)){
                obj.synonyms.forEach(child=>{
                    if(typeof child==="string") child={word:child,synonyms:[]};
                    addNode(child,obj,level+1);
                });
            }
        }

        addNode({word:data.source_word,synonyms:Array.isArray(data.synonyms)?data.synonyms:[]});

        // 初始化子節點靠近中心
        nodes.forEach(d=>{
            if(d.type!=="center"){
                d.x = width/2 + (Math.random()-0.5)*50;
                d.y = height/2 + (Math.random()-0.5)*50;
            }
        });

        const simulation = d3.forceSimulation(nodes)
            .force("link",d3.forceLink(links).id(d=>d.id).distance(d=>d.source.type==="center"?120:80).strength(1))
            .force("charge",d3.forceManyBody().strength(d=>d.type==="center"?-200:-70))
            .force("center",d3.forceCenter(width/2,height/2))
            .force("collision",d3.forceCollide().radius(d=>d.type==="center"?40:22))
            .alpha(1).restart();

        // 固定中心
        nodes.forEach(d=>{ if(d.type==="center"){ d.fx=width/2; d.fy=height/2; }});

        const link = svg.append("g").attr("stroke","#cbd5e1")
            .selectAll("line").data(links).enter().append("line").attr("stroke-width",1.5);

        const node = svg.append("g").selectAll("g").data(nodes)
            .enter().append("g")
            .call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));

        node.append("circle")
            .attr("r",d=>d.type==="center"?35:20)
            .attr("fill",d=>d.type==="center"?"#4B5563":colors[d.level % colors.length])
            .on("click",(event,d)=>{
                if(d.type==="synonym"){
                    wordInput.value=d.id;
                    fetchWordRelations(d.id);
                }
            });

        node.append("text")
            .text(d=>d.id)
            .attr("text-anchor","middle")
            .attr("dy",".35em")
            .attr("pointer-events","none")
            .attr("font-size",d=>d.type==="center"?14:12)
            .attr("fill",d=>d.type==="center"?"#ffffff":"#0f172a");

        simulation.on("tick",()=>{
            link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
                .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
            node.attr("transform",d=>`translate(${d.x},${d.y})`);
        });

        function dragstarted(event,d){ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
        function dragged(event,d){ d.fx=event.x; d.fy=event.y; }
        function dragended(event,d){ if(!event.active) simulation.alphaTarget(0); if(d.type!=="center"){ d.fx=null; d.fy=null; } }
    }
});
</script>
<footer class="footer">
        <div class="footer-container">
            <div class="contact-us">
                <h3>聯絡我們</h3>
                <ul>
                    <li><i class="fas fa-phone"></i><a href="tel:02 3322 2777"> 電話：02 3322 2777</a></li>
                    <li><i class="fas fa-map"></i><a href="https://maps.app.goo.gl/3NMVwufcbbTrfQNz6" target="_blank"> 地址：100台北市中正區濟南路一段321號</a></li>
                    <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d14459.01851827243!2d121.5254698!3d25.0423998!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a970a11a84ad%3A0x58e05f2528812097!2z5ZyL56uL6Ie65YyX5ZWG5qWt5aSn5a24!5e0!3m2!1szh-TW!2stw!4v1728891709611!5m2!1szh-TW!2stw"
                        height="250"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 TOEIC學習平台 版權所有</p>
        </div>
    </footer>
</body>
</html>