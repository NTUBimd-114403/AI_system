{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC學習平台</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="{% static 'script/all.js' %}"></script>
</head>
<body {% if not user.is_authenticated %}class="no-auth"{% endif %}>
    <div class="header">
        <button class="menu-btn" id="menu-btn">☰</button>
        <h1>TOEIC學習平台</h1>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <div class="nav-buttons">
            <a href="{% url 'home' %}" target="_self">
                <button class="nav-btn {% if request.path == '/' %}current{% endif %}">
                    <i class="fas fa-home"></i> 首頁
                </button>
            </a>
        
            <a href="{% url 'test' %}" target="_self">
                <button class="nav-btn {% if request.path == '/test/' %}current{% endif %}">
                    <i class="fas fa-file-alt"></i> 測驗平台
                </button>
            </a>
        
            {% if user.is_authenticated %}
              <a href="{% url 'relation_map' %}" target="_self">
        <button class="nav-btn {% if request.path == '/relation-map/' %}current{% endif %}">
            <i class="fas fa-project-diagram"></i> 單字關聯地圖
        </button>
    </a>
                <a href="{% url 'history' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/history/' %}current{% endif %}">
                        <i class="fas fa-history"></i> 歷史單字
                    </button>
                </a>
                <a href="{% url 'record' %}" target="_self">
                    <button class="nav-btn">
                        <i class="fas fa-user"></i> 學習歷程
                    </button>
                </a>
                <a href="{% url 'faq' %}" target="_self">
                    <button class="nav-btn">
                        <i class="fas fa-question-circle"></i> 常見問題
                    </button>
                </a>
                <a href="{% url 'profile-settings' %}" target="_self">
                            <button class="nav-btn {% if request.path == '/profile-settings/' %}current{% endif %}">
                                <i class="fas fa-cog"></i> 歡迎, {{ user.nickname }}
                            </button>
                        </a>
                <form id="logout-form" action="{% url 'logout' %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn">
                        <i class="fas fa-sign-out-alt"></i> 登出
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/login/' %}current{% endif %}">
                        <i class="fas fa-user"></i> 會員註冊/登入
                    </button>
                </a>
            {% endif %}
        </div>
    </div>
    <div class="main-content">
        <div class="hero-section">
            <div class="hero-content">
                <h1 id="slogan-text">智慧多益學習平台</h1>
                <p>運用 AI 技術，為多益應試者提供個人化、高效的學習解決方案。</p>
                <a href="{% if user.is_authenticated %}{% url 'test' %}{% else %}{% url 'login' %}{% endif %}" class="cta-button">開始探索</a>
            </div>
            <div class="scroll-down-indicator">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
       <section class="daily-phrase-section">
    <h2>今日片語</h2>
    <div class="phrase-card-container">
        {% if daily_phrases %}
            {% for phrase in daily_phrases %}
                <div class="phrase-card {% if forloop.first %}active{% endif %}">
                    <div class="phrase-header">
                        <span class="phrase-topic">{{ phrase.title }}</span>
                        <span class="phrase-topic-translation">{{ phrase.title_translation }}</span>
                    </div>
                    <p class="english-phrase">{{ phrase.english_passage }}</p>
                    <p class="chinese-translation">{{ phrase.chinese_translation }}</p>
                </div>
            {% endfor %}
        {% else %}
            <div class="loading-message">
                {% if error_message %}
                    <span>{{ error_message }}</span>
                {% else %}
                    <div class="loading-spinner"></div>
                    <span>今日片語載入中...</span>
                {% endif %}
            </div>
        {% endif %}
    </div>
</section>

        <div class="feature-showcase-section">
            <div class="showcase-item">
                <img src="{% static 'img/logo.png' %}" alt="多益考試簡介圖示" class="showcase-inline-image">
                <div class="showcase-content fade-in-up">
                    <h2>欸!愛多益 簡介</h2>
                    <p>我們的平台運用 AI 技術，為多益應試者提供高效的學習解決方案。從即時的數據分析到多元的模擬測驗，讓您在短時間內精準提升應試能力，高效達成高分目標。</p>
                </div>
            </div>
        </div>
        <div class="how-to-start-section">
            <h2>如何開始您的學習之旅？</h2>
            <div class="steps-container">
                <div class="step-item fade-in-up">
                    <div class="icon-circle"><i class="fas fa-user-plus"></i></div>
                    <h3>註冊帳號</h3>
                    <p>只需幾分鐘，快速建立您的個人學習檔案，開啟專屬的學習體驗。</p>
                </div>
                <div class="step-item fade-in-up">
                    <div class="icon-circle"><i class="fas fa-pencil-alt"></i></div>
                    <h3>開始練習</h3>
                    <p>系統將根據您的程度與需求，動態生成個人化練習題，隨時隨地開始學習。</p>
                </div>
                <div class="step-item fade-in-up">
                    <div class="icon-circle"><i class="fas fa-chart-line"></i></div>
                    <h3>個人學習路徑</h3>
                    <p>透過視覺化數據圖表，您可以清晰掌握自己的學習進度與表現，精準補強。</p>
                </div>
            </div>
        </div>
        <div class="blog-section">
            <h2>最新多益學習資訊</h2>
            <div class="blog-grid">
                <div class="blog-card fade-in-up">
                    <h3>多益官方試題範例</h3>
                    <p>透過官方提供的聽力與閱讀試題，熟悉考試題型與作答節奏，為正式考試做好萬全準備。</p>
                    <a href="https://www.toeic.com.tw/sample-test/toeic-listening-reading/sample01.html" class="read-more" target="_blank">
                        閱讀更多 <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="blog-card fade-in-up">
                    <h3>多益聽力訓練技巧</h3>
                    <p>掌握情境式聽力訓練法，從簡短對話到長篇聽力，有效提升您的聽力理解與應答速度。</p>
                    <a href="#" class="read-more">閱讀更多 <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="blog-card fade-in-up">
                    <h3>高效背單字：科學方法大公開</h3>
                    <p>告別死記硬背，透過科學方法，讓單字牢牢地印在腦中。</p>
                    <a href="#" class="read-more">閱讀更多 <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="footer-container">
            <div class="contact-us">
                <h3>聯絡我們</h3>
                <ul>
                    <li><i class="fas fa-phone"></i><a href="tel:02 3322 2777"> 電話：02 3322 2777</a></li>
                    <li><i class="fas fa-map"></i><a href="https://maps.app.goo.gl/3NMVwufcbbTrfQNz6" target="_blank"> 地址：100台北市中正區濟南路一段321號</a></li>
                    <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d14459.01851827243!2d121.5254698!3d25.0423998!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a970a11a84ad%3A0x58e05f2528812097!2z5ZyL56uL6Ie65YyX5ZWG5qWt5aSn5a24!5e0!3m2!1szh-TW!2stw!4v1728891709611!5m2!1szh-TW!2stw" 
                    width="300"
                    height="250"
                    style="border:0;"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 TOEIC學習平台 版權所有</p>
        </div>
    </footer>
    <div id="ai-chatbot-container" style="display: none;">
        <div id="chatbot-header">
            多益單字小幫手
            <button id="chatbot-close-btn">×</button>
        </div>
        <div id="chatbot-messages">
        </div>
        <div id="chatbot-input-area">
            <input type="text" id="user-input" placeholder="輸入「開始」來領取單字...">
            <button id="send-btn">發送</button>
        </div>
    </div>
    <button id="chatbot-toggle-btn">多益單字小幫手</button>
    <script>
        // 英雄區塊標語輪播
        const sloganText = document.getElementById('slogan-text');
        const slogans = [
            "智慧多益學習平台",
            "個人化英語學習方案",
            "從概念到實踐：AI 學習系統"
        ];
        let currentSloganIndex = 0;
        setInterval(() => {
            currentSloganIndex = (currentSloganIndex + 1) % slogans.length;
            sloganText.style.opacity = '0';
            setTimeout(() => {
                sloganText.textContent = slogans[currentSloganIndex];
                sloganText.style.opacity = '1';
            }, 500);
        }, 5000);
        // 滾動時淡入滑入動畫
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.2
        });
        document.querySelectorAll('.fade-in-up').forEach(element => {
            observer.observe(element);
        });
        // ✅ 根據後端傳來的使用者名稱，建立一個唯一的 localStorage key
        const currentUsername = "{{ user.username }}";
        const storageKey = `chatbot_history_${currentUsername}`;
        // 檢查使用者是否已登入
        const isAuthenticated = "{{ user.is_authenticated }}" === "True";
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        // 我將原本在 DOMContentLoaded 內的程式碼移到外面，並用一個新的 DOMContentLoaded 來包裹，以確保所有元素都已載入
        document.addEventListener('DOMContentLoaded', function() {
            const chatbotContainer = document.getElementById('ai-chatbot-container');
            const chatbotToggleBtn = document.getElementById('chatbot-toggle-btn');
            const chatbotCloseBtn = document.getElementById('chatbot-close-btn');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const csrfToken = getCookie('csrftoken');
            const logoutForm = document.getElementById('logout-form');
            const cards = document.querySelectorAll('.phrase-card');
            let currentCardIndex = 0;
            const cardCount = cards.length;
            if (cardCount > 1) {
                // 函式：切換到下一張卡片
                const showNextCard = () => {
                    // 移除目前顯示卡片的 active 類別
                    cards[currentCardIndex].classList.remove('active');
                    // 計算下一個卡片的索引，並確保它在範圍內（使用模數運算實現循環）
                    currentCardIndex = (currentCardIndex + 1) % cardCount;
                    // 新增 active 類別以顯示下一張卡片
                    cards[currentCardIndex].classList.add('active');
                };
                // 只有在卡片數量大於1時才啟動自動輪播
                setInterval(showNextCard, 15000); // 每 15 秒切換一次
            }
            // 如果使用者未登入，則直接結束，不執行 AI 機器人相關的邏輯
            if (!isAuthenticated) {
                if (chatbotToggleBtn) {
                    chatbotToggleBtn.style.display = 'none';
                }
                return;
            }
            // 負責為所有單字卡片按鈕綁定事件
            function bindFamiliarButtonEvents() {
                const buttons = chatbotMessages.querySelectorAll('.mark-familiar-btn');
                buttons.forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', function(e) {
                        const wordId = e.target.dataset.wordId;
                        markWordAsFamiliar(wordId);
                    });
                });
            }
            // 從 localStorage 載入對話紀錄
            function loadChatHistory() {
                const history = localStorage.getItem(storageKey);
                if (history) {
                    chatbotMessages.innerHTML = history;
                    bindFamiliarButtonEvents();
                } else {
                    addMessage('robot', '哈囉！我是你的 AI 學習小幫手。輸入「開始」來領取你今天的單字吧！');
                }
            }
            // 將對話紀錄保存到 localStorage
            function saveChatHistory() {
                localStorage.setItem(storageKey, chatbotMessages.innerHTML);
            }
            function addMessage(sender, htmlContent, isVocabCard = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chatbot-message', `${sender}-message`);
                messageDiv.innerHTML = htmlContent;
                chatbotMessages.appendChild(messageDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                saveChatHistory();
                if (isVocabCard) {
                    bindFamiliarButtonEvents();
                }
            }
            chatbotToggleBtn.addEventListener('click', () => {
                chatbotContainer.style.display = 'flex';
                chatbotToggleBtn.style.display = 'none';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            });
            chatbotCloseBtn.addEventListener('click', () => {
                chatbotContainer.style.display = 'none';
                chatbotToggleBtn.style.display = 'block';
            });
            if (logoutForm) {
                logoutForm.addEventListener('submit', function() {
                    // 在登出前，清除當前使用者的聊天紀錄
                    localStorage.removeItem(storageKey);
                });
            }
            function sendMessage() {
                const message = userInput.value.trim();
                if (message === '') return;
                addMessage('user', message);
                userInput.value = '';
                if (message.toLowerCase() === '開始') {
                    fetchDailyVocabulary();
                } else {
                    addMessage('robot', '抱歉，我目前只能識別「開始」指令來提供單字喔！');
                }
            }
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            function fetchDailyVocabulary() {
                fetch('/api/chatbot/vocabulary/', {
                    method: 'GET',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.words && data.words.length > 0) {
                        addMessage('robot', data.message);
                        data.words.forEach(word => {
                            const card = `
                                <div class="vocab-card">
                                    <h4>
                                        <span class="word-text">${word.word}</span>
                                        <span class="word-translation">${word.translation}</span>
                                        <span class="pronunciation-text">${word.pronunciation}</span>
                                        <span class="part-of-speech">${word.part_of_speech}</span>
                                    </h4>
                                    <p class="example-sentence">例句：${word.example_sentence}</p>
                                    <p class="example-translation">翻譯：${word.example_translation}</p>
                                    <button class="mark-familiar-btn" data-word-id="${word.word_id}">我已熟悉這個單字</button>
                                </div>
                            `;
                            addMessage('robot', card, true);
                        });
                    } else {
                        addMessage('robot', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching vocabulary:', error);
                    addMessage('robot', '糟糕！無法取得單字，請稍後再試。');
                });
            }
            function markWordAsFamiliar(wordId) {
                const button = chatbotMessages.querySelector(`button[data-word-id="${wordId}"]`);
                if (!button) {
                    return;
                }
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '處理中...';
                button.classList.add('loading'); 
                fetch('/api/chatbot/mark-familiar/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ word_id: wordId })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server responded with an error!');
                    }
                    return response.json();
                })
                .then(data => {
                    button.textContent = '已標記';
                    button.classList.add('marked'); 
                    button.classList.remove('loading');
                    addMessage('robot', data.message);
                })
                .catch(error => {
                    console.error('Error marking word as familiar:', error);
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('loading');
                    addMessage('robot', '標記單字時發生錯誤，請稍後再試。');
                });
            }
            loadChatHistory();
        });
    </script>
</body>
</html>
