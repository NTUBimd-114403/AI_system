{% extends "mgmt_base.html" %}
{% block title %}
欸！愛多益 - 後台使用者管理
{% endblock %}

{% block content %}
<div class="container-user">
    <div class="data">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Email(PK)</th>
                    <th>暱稱</th>
                    <th>點數</th>
                    <th>權限</th>
                    <th>註冊時間</th>
                    <th>狀態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.email }}</td>
                    <td>{{ user.nickname }}</td>
                    <td>{{ user.point }}</td>
                    <td>
                        {% if user.is_staff %}
                            <span class="badge badge-admin">管理員</span>
                        {% else %}
                            <span class="badge badge-user">一般用戶</span>
                        {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if user.is_active %}
                            <span class="status-active">啟用</span>
                        {% else %}
                            <span class="status-inactive">停用</span>
                        {% endif %}
                    </td>
                    <td class="button_td">
                        <button onclick="editUser('{{ user.email }}')">編輯</button>
                        <button onclick="deleteUser('{{ user.email }}')">刪除</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="toolbar">
        <button onclick="openAddModal()" class="btn-primary">
            <i class="fa-solid fa-plus fa-lg"></i>
            <p>新增使用者</p>
        </button>
    </div>
</div>
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>編輯使用者</h3>
        <form id="editUserForm">
            <input type="hidden" id="edit-email">
            <label>暱稱</label>
            <input type="text" id="edit-nickname">
            <label>點數</label>
            <input type="number" id="edit-point">
            <label>權限</label>
            <select id="edit-is-staff">
                <option value="false">一般用戶</option>
                <option value="true">管理員</option>
            </select>
            <label>狀態</label>
            <select id="edit-is-active">
                <option value="true">啟用</option>
                <option value="false">停用</option>
            </select>
            <div class="form-actions">
                <button type="submit">儲存</button>
            </div>
        </form>
    </div>
</div>
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h3>新增使用者</h3>
        <form id="addUserForm">
            <label for="add-email">Email</label>
            <input type="email" id="add-email" required>
            
            <label for="add-nickname">暱稱</label>
            <input type="text" id="add-nickname" required>
            
            <label for="add-password">密碼</label>
            <input type="password" id="add-password" required>
            
            <label for="add-point">點數</label>
            <input type="number" id="add-point" value="0" min="0">
            
            <label for="add-is-staff">權限</label>
            <select id="add-is-staff">
                <option value="false">一般用戶</option>
                <option value="true">管理員</option>
            </select>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">新增</button>
                <button type="button" class="btn-cancel" onclick="closeAddModal()">取消</button>
            </div>
        </form>
    </div>
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openAddModal() {
        document.getElementById('addUserModal').style.display = 'block';
    }

    function closeAddModal() {
        document.getElementById('addUserModal').style.display = 'none';
        document.getElementById('addUserForm').reset();
    }

    function deleteUser(email) {
        Swal.fire({
            title: '確認刪除',
            text: `確定要刪除使用者 ${email} 嗎？此操作無法復原！`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '確定刪除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/mgmt/api/user/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            text: '使用者已刪除',
                            timer: 1500
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            text: data.error || '刪除失敗'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        text: '發生錯誤'
                    });
                });
            }
        });
    }

    function editUser(email) {
        // 取得使用者資料
        fetch(`/mgmt/api/user/${email}/`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('edit-email').value = data.email;
                document.getElementById('edit-nickname').value = data.nickname;
                document.getElementById('edit-point').value = data.point;
                document.getElementById('edit-is-staff').value = data.is_staff;
                document.getElementById('edit-is-active').value = data.is_active;
                document.getElementById('editUserModal').style.display = 'block';
            });
    }

    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            email: document.getElementById('add-email').value,
            nickname: document.getElementById('add-nickname').value,
            password: document.getElementById('add-password').value,
            point: parseInt(document.getElementById('add-point').value),
            is_staff: document.getElementById('add-is-staff').value === 'true'
        };
        
        fetch('/mgmt/api/user/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                closeAddModal();
                Swal.fire({
                    icon: 'success',
                    text: '使用者新增成功',
                    timer: 1500
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    text: data.error || '新增失敗'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                text: '發生錯誤'
            });
        });
    });

    // 關閉 Modal
    document.querySelector('.close').onclick = function() {
        document.getElementById('editUserModal').style.display = 'none';
    }

    // 提交表單
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {
        email: document.getElementById('edit-email').value,
        nickname: document.getElementById('edit-nickname').value,
        point: document.getElementById('edit-point').value,
        is_staff: document.getElementById('edit-is-staff').value === 'true',
        is_active: document.getElementById('edit-is-active').value === 'true'
    };
    
    fetch('/mgmt/api/user/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            document.getElementById('editUserModal').style.display = 'none';
            Swal.fire({
                icon: 'success',
                text: '使用者資料已更新',
                timer: 2250
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                text: data.error || '更新失敗'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            text: '發生錯誤，請稍後再試'
        });
    });
});
</script>
{% endblock %}