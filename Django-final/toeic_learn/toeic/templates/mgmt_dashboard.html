{% extends "mgmt_base.html" %}
{% block title %}æ¬¸ï¼æ„›å¤šç›Š - å¾Œå°çµ±è¨ˆå„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- é—œéµæŒ‡æ¨™å¡ç‰‡å€ -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
                <h3>ç¸½ç”¨æˆ¶æ•¸</h3>
                <p class="stat-value" id="totalUsers">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-content">
                <h3>ç¸½æ¸¬é©—æ¬¡æ•¸</h3>
                <p class="stat-value" id="totalExams">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <h3>å¹³å‡åˆ†æ•¸</h3>
                <p class="stat-value" id="avgScore">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-content">
                <h3>é»æ•¸æµé€šé‡</h3>
                <p class="stat-value" id="totalPoints">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â“</div>
            <div class="stat-content">
                <h3>ç¸½é¡Œç›®æ•¸</h3>
                <p class="stat-value" id="totalQuestions">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“š</div>
            <div class="stat-content">
                <h3>ç¸½å–®å­—æ•¸</h3>
                <p class="stat-value" id="totalVocab">-</p>
            </div>
        </div>
    </div>

    <!-- é€²åº¦æ¢å€ -->
    <div class="progress-section">
        <div class="progress-card">
            <h4>å¹³å‡å®Œæˆç‡</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="completionRate" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="completionText">0%</p>
        </div>
        <div class="progress-card">
            <h4>ç†Ÿæ‚‰å–®å­—æ¯”ä¾‹</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="familiarRate" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="familiarText">0%</p>
        </div>
    </div>

    <!-- åœ–è¡¨å€ -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>æ–°å¢ç”¨æˆ¶è¶¨å‹¢ (è¿‘30å¤©)</h3>
            <canvas id="userTrendChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>æ¯æ—¥æ¸¬é©—æ¬¡æ•¸è¶¨å‹¢ (è¿‘30å¤©)</h3>
            <canvas id="examTrendChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ç¶œåˆæ¸¬é©— vs å–®ä¸€Part</h3>
            <canvas id="examTypeChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å„é¡äº¤æ˜“åŸå› åˆ†å¸ƒ</h3>
            <canvas id="transactionChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å„ Part æ¸¬é©—æ¬¡æ•¸åˆ†å¸ƒ</h3>
            <canvas id="examPartChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å„ Part é¡Œç›®åˆ†å¸ƒ</h3>
            <canvas id="questionPartChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å„é›£åº¦é¡Œç›®æ•¸é‡</h3>
            <canvas id="difficultyChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>é¡Œç›®å¯©æ ¸ç‹€æ…‹</h3>
            <canvas id="approvalChart"></canvas>
        </div>
    </div>

    <!-- åˆ†æ•¸æ˜ç´° -->
    <div class="score-section">
        <div class="score-card">
            <h4>ğŸ§ è½åŠ›å¹³å‡åˆ†æ•¸</h4>
            <p class="score-value" id="listenScore">-</p>
        </div>
        <div class="score-card">
            <h4>ğŸ“– é–±è®€å¹³å‡åˆ†æ•¸</h4>
            <p class="score-value" id="readingScore">-</p>
        </div>
        <div class="score-card">
            <h4>ğŸ“ˆ å­¸ç¿’è¨˜éŒ„æ•¸</h4>
            <p class="score-value" id="vocabRecords">-</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    fetch('/mgmt/api/dashboard/stats/')
        .then(r => r.json())
        .then(data => {
            // æ›´æ–°æ•¸å­—å¡ç‰‡
            document.getElementById('totalUsers').textContent = data.total_users.toLocaleString();
            document.getElementById('totalExams').textContent = data.total_exams.toLocaleString();
            document.getElementById('avgScore').textContent = data.avg_score.toFixed(1);
            document.getElementById('totalPoints').textContent = data.total_points.toLocaleString();
            document.getElementById('totalQuestions').textContent = data.total_questions.toLocaleString();
            document.getElementById('totalVocab').textContent = data.total_vocab.toLocaleString();
            document.getElementById('listenScore').textContent = data.avg_listen_score.toFixed(1);
            document.getElementById('readingScore').textContent = data.avg_reading_score.toFixed(1);
            document.getElementById('vocabRecords').textContent = data.vocab_records.toLocaleString();

            // æ›´æ–°é€²åº¦æ¢
            const completionRate = data.completion_rate;
            document.getElementById('completionRate').style.width = completionRate + '%';
            document.getElementById('completionText').textContent = completionRate.toFixed(1) + '%';

            const familiarRate = data.familiar_rate;
            document.getElementById('familiarRate').style.width = familiarRate + '%';
            document.getElementById('familiarText').textContent = familiarRate.toFixed(1) + '%';

            // æ–°å¢ç”¨æˆ¶è¶¨å‹¢åœ–
            new Chart(document.getElementById('userTrendChart'), {
                type: 'line',
                data: {
                    labels: data.user_trend.dates,
                    datasets: [{
                        label: 'æ–°å¢ç”¨æˆ¶æ•¸',
                        data: data.user_trend.counts,
                        borderColor: '#c0e686',
                        backgroundColor: 'rgba(192, 230, 134, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // æ¸¬é©—è¶¨å‹¢åœ–
            new Chart(document.getElementById('examTrendChart'), {
                type: 'line',
                data: {
                    labels: data.exam_trend.dates,
                    datasets: [{
                        label: 'æ¸¬é©—æ¬¡æ•¸',
                        data: data.exam_trend.counts,
                        borderColor: '#58585b',
                        backgroundColor: 'rgba(88, 88, 91, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // ç¶œåˆvså–®ä¸€Partåœ“é¤…åœ–
            new Chart(document.getElementById('examTypeChart'), {
                type: 'pie',
                data: {
                    labels: ['ç¶œåˆæ¸¬é©—', 'å–®ä¸€Partæ¸¬é©—'],
                    datasets: [{
                        data: [data.exam_type_ratio.mixed, data.exam_type_ratio.single],
                        backgroundColor: ['#c0e686', '#d9ecbd']
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // äº¤æ˜“åŸå› åˆ†å¸ƒ
            new Chart(document.getElementById('transactionChart'), {
                type: 'pie',
                data: {
                    labels: data.transaction_reasons.labels,
                    datasets: [{
                        data: data.transaction_reasons.counts,
                        backgroundColor: ['#c0e686', '#d9ecbd', '#e9f6da']
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // Partæ¸¬é©—åˆ†å¸ƒ
            new Chart(document.getElementById('examPartChart'), {
                type: 'bar',
                data: {
                    labels: data.exam_part_dist.labels,
                    datasets: [{
                        label: 'æ¸¬é©—æ¬¡æ•¸',
                        data: data.exam_part_dist.counts,
                        backgroundColor: '#c0e686'
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // Parté¡Œç›®åˆ†å¸ƒ
            new Chart(document.getElementById('questionPartChart'), {
                type: 'bar',
                data: {
                    labels: data.question_part_dist.labels,
                    datasets: [{
                        label: 'é¡Œç›®æ•¸é‡',
                        data: data.question_part_dist.counts,
                        backgroundColor: '#58585b'
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // é›£åº¦åˆ†å¸ƒ
            new Chart(document.getElementById('difficultyChart'), {
                type: 'bar',
                data: {
                    labels: data.difficulty_dist.labels,
                    datasets: [{
                        label: 'é¡Œç›®æ•¸é‡',
                        data: data.difficulty_dist.counts,
                        backgroundColor: '#d9ecbd'
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });

            // å¯©æ ¸ç‹€æ…‹
            new Chart(document.getElementById('approvalChart'), {
                type: 'pie',
                data: {
                    labels: ['å·²å¯©æ ¸', 'å¾…å¯©æ ¸'],
                    datasets: [{
                        data: [data.approval_status.approved, data.approval_status.pending],
                        backgroundColor: ['#c0e686', '#ff6b6b']
                    }]
                },
                options: {responsive: true, maintainAspectRatio: true}
            });
        });
</script>
{% endblock %}